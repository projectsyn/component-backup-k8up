parameters:
  backup_k8up:
    # This switch is required to selectively disable the component
    # TODO: Reevaluate the need for this once we can remove components
    # See: https://github.com/projectsyn/commodore/issues/71
    enabled: true
    namespace: syn-backup
    global_backup_config:
      enabled: true
      default_backup_bucket: '${cluster:name}-k8up-backups'
      s3_credentials:
        accesskey: ''
        secretkey: ''
        secretname: global-bucket-credentials
        accesskeyname: username
        secretkeyname: password
      backup_secret:
        name: global-backup-password
        password: '?{vaultkv:${customer:name}/${cluster:name}/global-backup/password}'
      s3restore_credentials:
        accesskey: ''
        secretkey: ''
        secretname: global-restore-credentials
        accesskeyname: username
        secretkeyname: password
      restore_s3endpoint: null
      restore_bucket: null
      keepjobs: '3'
      stats_url: null
      s3_endpoint: null
    backofflimit: '2'
    annotation: k8up.syn.tools/backup
    backupcommandannotation: k8up.syn.tools/backupcommand
    tz: Europe/Zurich
    alert_rule_filters:
      namespace: namespace=~"syn.*"
    prometheus_push_gateway: 'http://platform-prometheus-pushgateway.syn-synsights.svc:9091'
    prometheus_name: main
    monitoring_enabled: true
    monitoring_alerts:
      k8up_last_errors:
        annotations:
          message: Last backup for PVC {{ $labels.pvc }} in namespace {{ $labels.instance }} had {{ $value }} errors
        expr: baas_backup_restic_last_errors{${backup_k8up:alert_rule_filters:namespace}} > 0
        for: 1m
        labels:
          severity: critical
      K8upBackupFailed:
        annotations:
          message: Job in {{ $labels.exported_namespace }} of type {{ $labels.jobType }} failed
        expr: rate(k8up_jobs_failed_counter[1d]) > 0
        for: 1m
        labels:
          severity: critical
      K8upBackupNotRunning:
        annotations:
          message: No K8up jobs were run in {{ $labels.exported_namespace }} within the last 24 hours. Check the operator, there might be a deadlock
        expr: sum(rate(k8up_jobs_total[25h])) == 0 and on(namespace) k8up_schedules_gauge > 0
        for: 1m
        labels:
          severity: critical
      K8upJobStuck:
        annotations:
          message: K8up jobs are stuck in {{ $labels.exported_namespace }} for the last 24 hours.
        expr: k8up_jobs_queued_gauge{jobType="backup"} > 0 and on(namespace) k8up_schedules_gauge > 0
        for: 24h
        labels:
          severity: critical
    charts:
      k8up: 0.6.1
    images:
      k8up:
        image: quay.io/vshn/k8up
        tag: 'v0.1.10@sha256:74ef61f26c85b4a6ab6b02761caefe6d59234db559f7ed6bb7430f345b7ac488'
      wrestic:
        image: quay.io/vshn/wrestic
        tag: 'v0.1.9@sha256:6b756ddb70e15977fc3d53a0468bcf6386d79d989768d48696167161f20e115e'
